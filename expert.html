<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Expert Dashboard - AdoptEase</title>
  <!-- External Resources -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Base Styles */
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #e9f5f1;
    }

    /* Container Styles */
    .expert-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      background-color: #e9f5f1;
    }

    /* Header Styles */
    .expert-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #d0d0d0;
    }

    .logo-name-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 0 auto;
    }

    .logo {
      width: 70px;
      height: auto;
    }

    .company-name {
      font-size: 3rem;
      font-weight: 700;
      color: #222;
    }

    /* Button Styles */
    .logout-btn {
      background-color: #fff;
      color: #333;
      border: 1px solid #ccc;
      padding: 0.6rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .logout-btn:hover {
      background-color: #f2f2f2;
    }

    /* Table Styles */
    .table {
      width: auto;
      margin-bottom: 1rem;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .table th, .table td {
      text-align: center !important;
      vertical-align: middle;
      padding: 1rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .table th {
      background-color: #f0f9f6;
      font-weight: 600;
      color: #333;
      white-space: nowrap;
    }

    .table td {
      white-space: nowrap;
    }

    /* Center align all input fields */
    .table input {
      text-align: center !important;
      width: 100%;
    }

    /* Column Widths - Set to minimum required space */
    .table th:nth-child(1), .table td:nth-child(1) { min-width: 50px; } /* ID */
    .table th:nth-child(2), .table td:nth-child(2) { min-width: 120px; } /* Name */
    .table th:nth-child(3), .table td:nth-child(3) { min-width: 200px; } /* Breed */
    .table th:nth-child(4), .table td:nth-child(4) { min-width: 80px; } /* Age */
    .table th:nth-child(5), .table td:nth-child(5) { min-width: 250px; } /* Color */
    .table th:nth-child(6), .table td:nth-child(6) { min-width: 100px; } /* Height */
    .table th:nth-child(7), .table td:nth-child(7) { min-width: 100px; } /* Weight */
    .table th:nth-child(8), .table td:nth-child(8) { min-width: 300px; } /* Vaccines */
    .table th:nth-child(9), .table td:nth-child(9) { min-width: 200px; } /* Diseases */
    .table th:nth-child(10), .table td:nth-child(10) { min-width: 300px; } /* Medical History */
    .table th:nth-child(11), .table td:nth-child(11) { min-width: 300px; } /* Personality */
    .table th:nth-child(12), .table td:nth-child(12) { min-width: 100px; } /* Actions */

    .table tr:hover {
      background-color: #f8f8f8;
    }

    .table-responsive {
      border-radius: 12px;
      overflow-x: auto;
      width: 100%;
      margin-bottom: 1rem;
      -webkit-overflow-scrolling: touch;
    }

    /* Message and Filter Section Styles */
    .no-users-message {
      padding: 2rem;
      text-align: center;
      color: #555;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .filter-section {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }
  </style>

</head>

<body>
  <div class="expert-container">
    <div class="expert-header">
      <div class="logo-name-wrapper">
        <img src="MY_LOGO.PNG" alt="AdoptEase Logo" class="logo" />
        <div class="company-name">AdoptEase</div>
      </div>
      <button class="logout-btn" id="logout-btn">Sign out</button>
    </div>
    <div class="container py-4">
      <h2 class="mb-4 text-center">Expert Dashboard - Registered Dogs</h2>

      <!-- Add New Dog Button -->


      <!-- Add Dog Form -->
      <div id="total-count">Total Dogs: 0</div>
      <!-- Dogs Table -->
      <div class="table-responsive">
        <table class="table table-hover table-bordered bg-white align-middle">
          <thead class="table-light">
            <tr>
              <th>IDüÜî</th>
              <th>Nameüè∑Ô∏è</th>
              <th>Breedüê∂</th>
              <th style="min-width: 80px;">AgeüéÇ</th>
              <th>Colorüé®</th>
              <th>Height(cm)üìè</th>
              <th>Weight(kg)‚öñÔ∏è</th>
              <th>Vaccinesüíâ</th>
              <th>Diseases‚úÖ</th>
              <th>Medical Historyü©∫</th>
              <th>Personalityüåü</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="dogTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- JS Scripts -->
    <script>
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/index.html';
      }

      function updateDog(id) {
        const inputs = document.querySelectorAll(`[data-id="${id}"]`);
        const updatedData = {};
        inputs.forEach(input => {
          const value = input.value.trim();
          const field = input.dataset.field;
          
          // Skip empty values for optional fields
          if (value === '' && ['color', 'vaccines', 'diseases', 'medical_history', 'personality'].includes(field)) {
            updatedData[field] = null; // Set to null instead of skipping
            return;
          }
          
          // Convert numeric fields
          if (['age', 'height', 'weight'].includes(field)) {
            const numValue = parseFloat(value);
            if (isNaN(numValue)) {
              alert(`Invalid ${field} value`);
              return;
            }
            updatedData[field] = numValue;
          } else {
            updatedData[field] = value;
          }
        });

        // Validate numeric fields
        if (updatedData.age !== undefined && (updatedData.age < 0 || updatedData.age > 30)) {
          alert('Age must be between 0 and 30 years');
          return;
        }
        if (updatedData.height !== undefined && (updatedData.height <= 0 || updatedData.height > 200)) {
          alert('Height must be between 0 and 200 cm');
          return;
        }
        if (updatedData.weight !== undefined && (updatedData.weight <= 0 || updatedData.weight > 100)) {
          alert('Weight must be between 0 and 100 kg');
          return;
        }

        // Show loading state
        const saveButton = document.querySelector(`button[onclick="updateDog(${id})"]`);
        const originalText = saveButton.textContent;
        saveButton.textContent = 'Saving...';
        saveButton.disabled = true;

        fetch(`/api/expert/dogs/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(updatedData)
        })
          .then(res => {
            if (!res.ok) {
              return res.json().then(data => {
                throw new Error(data.message || 'Failed to update dog');
              });
            }
            return res.json();
          })
          .then(res => {
            console.log('Update successful:', res);
            loadDogs(); // Refresh the table
            alert('Dog information updated successfully');
          })
          .catch(err => {
            console.error('Error updating dog:', err);
            alert(err.message || 'Failed to update dog. Please check your input values.');
          })
          .finally(() => {
            // Restore button state
            saveButton.textContent = originalText;
            saveButton.disabled = false;
          });
      }

      function loadDogs() {
        // Show loading state
        const tbody = document.getElementById('dogTableBody');
        tbody.innerHTML = '<tr><td colspan="12" class="text-center">Loading dogs...</td></tr>';

        fetch('/api/expert/dogs', {
          headers: { Authorization: `Bearer ${token}` }
        })
          .then(res => {
            if (!res.ok) {
              return res.json().then(data => {
                throw new Error(data.message || 'Failed to fetch dogs');
              });
            }
            return res.json();
          })
          .then(data => {
            console.log('Fetched dogs:', data);
            const tbody = document.getElementById('dogTableBody');
            tbody.innerHTML = '';

            const dogs = data.dogs || [];

            if (!Array.isArray(dogs) || dogs.length === 0) {
              tbody.innerHTML = '<tr><td colspan="12" class="text-center">No dogs found.</td></tr>';
              document.getElementById("total-count").textContent = 'Total Dogs: 0';
              return;
            }
            
            document.getElementById("total-count").textContent = `Total Dogs: ${dogs.length}`;
            dogs.forEach(dog => {
              tbody.innerHTML += `
                <tr>
                  <td>${dog.id}</td>
                  <td>${dog.name}</td>
                  <td>${dog.breed}</td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="age" type="number" min="0" max="30" value="${dog.age || 0}" style="min-width: 80px;"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="color" value="${dog.color || ''}" placeholder="Enter color"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="height" type="number" step="0.1" min="0" max="200" value="${dog.height || ''}" placeholder="Height (cm)"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="weight" type="number" step="0.1" min="0" max="100" value="${dog.weight || ''}" placeholder="Weight (kg)"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="vaccines" value="${dog.vaccines || ''}"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="diseases" value="${dog.diseases || ''}"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="medical_history" value="${dog.medical_history || ''}"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="personality" value="${dog.personality || ''}"></td>
                  <td>
                    <button class="btn btn-success btn-sm" onclick="updateDog(${dog.id})">Save Changes</button>
                  </td>
                </tr>
              `;
            });
          })
          .catch(err => {
            console.error('Error fetching dogs:', err);
            tbody.innerHTML = 
              '<tr><td colspan="12" class="text-center text-danger">Failed to load dogs. Please try again later.</td></tr>';
          });
      }

      // Load dogs on page load
      loadDogs();

      // Handle logout
      document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = '/index.html';
      });
    </script>
</body>

</html>