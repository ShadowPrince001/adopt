<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Expert Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #e9f5f1;
    }

    .expert-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .expert-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #d0d0d0;
    }

    .logo-name-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 0 auto;
    }

    .logo {
      width: 70px;
      height: auto;
    }

    .company-name {
      font-size: 3rem;
      font-weight: 700;
      color: #222;
    }

    .expert-title {
      font-size: 2rem;
      font-weight: 700;
      color: #222;
      margin-bottom: 1rem;
    }

    .expert-subtitle {
      font-size: 1.5rem;
      font-weight: 600;
      color: #333;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }

    .logout-btn {
      background-color: #fff;
      color: #333;
      border: 1px solid #ccc;
      padding: 0.6rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .logout-btn:hover {
      background-color: #f2f2f2;
    }

    /* Table styles */
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin: 0 -2rem;
      padding: 0 2rem;
    }

    .table {
      font-size: 0.9rem;
      min-width: 1200px;
      width: 100%;
    }

    .table th, .table td {
      padding: 0.5rem;
      vertical-align: middle;
      white-space: nowrap;
    }

    .form-control {
      font-size: 0.9rem;
      padding: 0.25rem 0.5rem;
      width: 100%;
    }

    /* Remove fixed widths and let content determine width */
    .table th, .table td {
      min-width: 100px;
    }

    /* Specific columns that need more width */
    .table th:nth-child(10), .table td:nth-child(10) { min-width: 200px; } /* Medical History */
    .table th:nth-child(11), .table td:nth-child(11) { min-width: 150px; } /* Personality */

    /* Specific column widths */
    th:nth-child(1), td:nth-child(1) { width: 60px; } /* ID */
    th:nth-child(2), td:nth-child(2) { width: 120px; } /* Name */
    th:nth-child(3), td:nth-child(3) { width: 120px; } /* Breed */
    th:nth-child(4), td:nth-child(4) { width: 80px; } /* Age */
    th:nth-child(5), td:nth-child(5) { width: 100px; } /* Color */
    th:nth-child(6), td:nth-child(6) { width: 100px; } /* Height */
    th:nth-child(7), td:nth-child(7) { width: 100px; } /* Weight */
    th:nth-child(8), td:nth-child(8) { width: 150px; } /* Vaccines */
    th:nth-child(9), td:nth-child(9) { width: 150px; } /* Diseases */
    th:nth-child(12), td:nth-child(12) { width: 100px; } /* Actions */
  </style>

</head>

<body>
  <div class="expert-container">
    <div class="expert-header">
      <div class="logo-name-wrapper">
        <img src="MY_LOGO.PNG" alt="AdoptEase Logo" class="logo" />
        <div class="company-name">AdoptEase</div>
      </div>
      <button class="logout-btn" id="logout-btn">Sign out</button>
    </div>
    <div class="container py-4">
      <h2 class="mb-4 text-center">Expert Dashboard - Registered Dogs</h2>

      <!-- Add New Dog Button -->


      <!-- Add Dog Form -->
      <div id="total-count">Total Dogs: 0</div>
      <!-- Dogs Table -->
      <div class="table-responsive">
        <table class="table table-hover table-bordered bg-white align-middle">
          <thead class="table-light">
            <tr>
              <th>IDüÜî</th>
              <th>Nameüè∑Ô∏è</th>
              <th>Breedüê∂</th>
              <th style="min-width: 80px;">AgeüéÇ</th>
              <th>Colorüé®</th>
              <th>Heightüìè</th>
              <th>Weight‚öñÔ∏è</th>
              <th>Vaccinesüíâ</th>
              <th>Diseases‚úÖ</th>
              <th>Medical Historyü©∫</th>
              <th>Personalityüåü</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="dogTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- JS Scripts -->
    <script>
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/index.html';
      }

      function updateDog(id) {
        const inputs = document.querySelectorAll(`[data-id="${id}"]`);
        const updatedData = {};
        inputs.forEach(input => {
          updatedData[input.dataset.field] = input.value;
        });

        // Frontend validation
        if (updatedData.age) {
          const age = parseInt(updatedData.age);
          if (age < 0 || age > 35) {
            alert('Age must be between 0 and 35 years');
            return;
          }
        }
        if (updatedData.height) {
          const height = parseFloat(updatedData.height);
          if (height < 7.5 || height > 150) {
            alert('Height must be between 7.5cm and 150cm');
            return;
          }
        }
        if (updatedData.weight) {
          const weight = parseFloat(updatedData.weight);
          if (weight < 0.25 || weight > 200) {
            alert('Weight must be between 0.25kg and 200kg');
            return;
          }
        }

        // Show loading state
        const saveButton = document.querySelector(`button[onclick="updateDog(${id})"]`);
        const originalText = saveButton.textContent;
        saveButton.textContent = 'Saving...';
        saveButton.disabled = true;

        fetch(`/api/expert/dogs/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(updatedData)
        })
          .then(res => {
            if (!res.ok) {
              return res.json().then(data => {
                throw new Error(data.message || 'Failed to update dog');
              });
            }
            return res.json();
          })
          .then(res => {
            console.log('Update successful:', res);
            // Reload the table data
            loadDogs();
            // Show success message
            alert('Dog information updated successfully');
          })
          .catch(err => {
            console.error('Error updating dog:', err);
            alert(err.message || 'Failed to update dog. Please check your input values.');
          })
          .finally(() => {
            // Restore button state
            saveButton.textContent = originalText;
            saveButton.disabled = false;
          });
      }

      function loadDogs() {
        // Show loading state
        const tbody = document.getElementById('dogTableBody');
        tbody.innerHTML = '<tr><td colspan="12" class="text-center">Loading dogs...</td></tr>';

        fetch('/api/expert/dogs', {
          headers: { Authorization: `Bearer ${token}` }
        })
          .then(res => {
            if (!res.ok) {
              throw new Error('Failed to fetch dogs');
            }
            return res.json();
          })
          .then(data => {
            console.log('Fetched dogs:', data);
            const tbody = document.getElementById('dogTableBody');
            tbody.innerHTML = '';

            const dogs = data.dogs || [];

            if (!Array.isArray(dogs) || dogs.length === 0) {
              tbody.innerHTML = '<tr><td colspan="12" class="text-center">No dogs found.</td></tr>';
              document.getElementById("total-count").textContent = 'Total Dogs: 0';
              return;
            }
            
            document.getElementById("total-count").textContent = `Total Dogs: ${dogs.length}`;
            dogs.forEach(dog => {
              tbody.innerHTML += `
                <tr>
                  <td>${dog.id}</td>
                  <td>${dog.name}</td>
                  <td>${dog.breed}</td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="age" type="number" min="0" max="35" value="${dog.age || 0}" style="min-width: 80px;"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="color" value="${dog.color || ''}" placeholder="Enter color"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="height" type="number" step="0.1" min="7.5" max="150" value="${dog.height || ''}" placeholder="Height (cm)"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="weight" type="number" step="0.1" min="0.25" max="200" value="${dog.weight || ''}" placeholder="Weight (kg)"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="vaccines" value="${dog.vaccines || ''}"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="diseases" value="${dog.diseases || ''}"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="medical_history" value="${dog.medical_history || ''}"></td>
                  <td><input class="form-control" data-id="${dog.id}" data-field="personality" value="${dog.personality || ''}"></td>
                  <td>
                    <button class="btn btn-success btn-sm" onclick="updateDog(${dog.id})">Save Changes</button>
                  </td>
                </tr>
              `;
            });
          })
          .catch(err => {
            console.error('Error fetching dogs:', err);
            tbody.innerHTML = 
              '<tr><td colspan="12" class="text-center text-danger">Failed to load dogs. Please try again later.</td></tr>';
          });
      }

      // Load dogs on page load
      loadDogs();

      // Handle logout
      document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = '/index.html';
      });
    </script>
</body>

</html>